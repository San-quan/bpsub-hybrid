# 使用指南 - AI 客服小安

## 🎯 项目概述

这是一个集成 OpenAI GPT-4o-mini 的 Telegram 智能客服机器人，专为「优质三方会员服务应用」打造。

### 核心特性
- 🤖 **AI 智能回复** - GPT-4o-mini 驱动，24/7 在线
- 👥 **人机协作** - AI 初步响应 + 人工深度支持
- 📊 **工单管理** - 自动创建、追踪、关闭工单
- 🔄 **实时转发** - 用户消息即时同步到客服群组
- 📝 **智能表单** - 自动生成会员注册表、退款申请表
- 💾 **数据持久化** - MongoDB 存储所有对话记录

## 📋 当前配置

| 配置项 | 值 |
|--------|-----|
| Bot Token | `8584335653:AAFxKjEZBD-w98XJG26TmxaliC-Yb5` |
| 管理员 ID | `6919196077` |
| 客服群组 ID | `-10034038523` |
| AI 模型 | `gpt-4o-mini` |
| AI 状态 | ✅ 已启用 |
| 匿名模式 | ❌ 禁用（显示用户名） |
| 工单号显示 | ✅ 启用 |

## 🚀 快速启动

### 方法 1: 使用启动脚本（推荐）

```bash
cd telegram-bot
./start.sh
```

### 方法 2: 手动启动

```bash
cd telegram-bot
docker-compose up -d

# 查看日志
docker-compose logs -f bot
```

## 📱 测试流程

### 1. 用户端测试

1. **启动对话**
   - 在 Telegram 搜索机器人（根据你的 bot username）
   - 发送 `/start`
   - 应该收到 AI 客服小安的欢迎消息

2. **测试 AI 回复**
   ```
   你好
   → 应收到: "您好！我是 AI 客服小安 🤖..."
   
   我想注册会员
   → 应收到: "欢迎注册会员！请告诉我您的邮箱..."
   
   我要退款
   → 应收到: "我会协助您处理退款申请..."
   ```

3. **测试命令**
   ```
   /help  → 查看帮助
   /faq   → 常见问题
   /id    → 查看自己的 ID
   ```

### 2. 客服端测试

1. **查看工单**
   - 进入客服群组（ID: -10034038523）
   - 应该看到用户消息被转发过来
   - 包含工单号、用户信息

2. **回复用户**
   - 在群组中**回复**用户消息
   - 用户端应该收到回复

3. **使用客服命令**
   ```
   /open    → 查看未处理工单
   /close   → 关闭当前工单
   /id      → 查看群组 ID
   ```

## 🤖 AI 客服功能

### AI 会做什么

✅ **自动回复常见问题**
- 注册咨询
- 退款流程
- 营业时间
- 价格查询

✅ **生成客服记录**
- 每次对话都会记录
- 自动附加到回复末尾

✅ **填写表单**
- 会员注册表
- 退款申请表

✅ **智能转接**
- 复杂问题自动提示 "@管理员"
- 人工客服无缝接管

### AI 不会做什么

❌ 不会擅自承诺价格、退款
❌ 不会泄露其他用户信息
❌ 不会处理付款操作
❌ 不确定时会请求人工确认

## 📊 系统架构

```
用户发送消息
    ↓
Telegram Bot 接收
    ↓
AI 分析并回复 ←──────┐
    ↓                  │
转发到客服群组          │
    ↓                  │
人工客服查看            │
    ↓                  │
需要介入？ ─── 是 ───→ 人工回复
    │
    否
    ↓
  继续 AI 处理
```

## 🔧 管理操作

### 查看日志

```bash
# 实时日志
docker-compose logs -f bot

# 查看最近 100 行
docker-compose logs --tail=100 bot

# 查看 MongoDB 日志
docker-compose logs mongodb
```

### 重启服务

```bash
# 重启 Bot
docker-compose restart bot

# 完全重启（包括 MongoDB）
docker-compose down && docker-compose up -d
```

### 查看状态

```bash
# 查看容器状态
docker-compose ps

# 查看资源占用
docker stats
```

### 备份数据

```bash
# 导出 MongoDB 数据
docker exec support-bot-mongodb mongodump --out /data/db/backup

# 复制到本地
docker cp support-bot-mongodb:/data/db/backup ./backup-$(date +%Y%m%d)
```

## 🔍 故障排查

### Bot 不回复

**检查项：**
```bash
# 1. 查看 Bot 日志
docker-compose logs bot | grep -i error

# 2. 检查 Bot Token
grep bot_token config/config.yaml

# 3. 测试网络连接
docker exec telegram-support-bot ping -c 3 api.telegram.org
```

### AI 不工作

**检查项：**
```bash
# 1. 确认 AI 已启用
grep use_llm config/config.yaml
# 应显示: use_llm: true

# 2. 检查 API Key
grep llm_api_key config/config.yaml

# 3. 查看 AI 相关日志
docker-compose logs bot | grep -i "llm\|openai\|gpt"
```

### 客服组收不到消息

**检查项：**
```bash
# 1. 确认群组 ID 正确（必须是负数）
grep staffchat_id config/config.yaml
# 应显示: staffchat_id: '-10034038523'

# 2. 确认机器人在群组中
# - 进入群组查看成员列表
# - 确认机器人存在且为管理员

# 3. 发送测试消息
# - 给机器人发消息
# - 查看日志是否有转发记录
```

### MongoDB 连接失败

**检查项：**
```bash
# 1. 检查 MongoDB 状态
docker-compose ps mongodb

# 2. 测试连接
docker exec -it support-bot-mongodb mongosh --eval "db.serverStatus()"

# 3. 查看连接配置
grep mongodb_uri config/config.yaml
```

## 📈 性能优化

### 减少 API 调用（降低成本）

在 `config.yaml` 中调整：

```yaml
# 减少 AI 调用频率
autoreply_confirmation: true  # 开启关键词自动回复
use_llm: true                 # 保持 AI 开启

# 优化自动回复规则
autoreply:
  - question: '常见问题关键词'
    answer: '固定回复内容'
```

### 防止刷屏

```yaml
spam_time: 60000      # 60秒内
spam_cant_msg: 5      # 最多5条消息
```

### 自动关闭旧工单

```yaml
auto_close_tickets: true  # 开启自动关闭
```

## 📝 常用命令速查

### 用户命令
```
/start - 开始使用
/help  - 帮助信息
/faq   - 常见问题
/id    - 查看 ID
```

### 客服命令
```
/open   - 查看未处理工单
/close  - 关闭工单
/reopen - 重开工单
/ban    - 封禁用户
/unban  - 解封用户
/clear  - 关闭所有工单
```

### 系统命令
```bash
./start.sh              # 启动服务
./stop.sh               # 停止服务
docker-compose ps       # 查看状态
docker-compose logs -f  # 查看日志
```

## 🎓 最佳实践

### 1. AI + 人工协作模式

**推荐流程：**
1. AI 先响应常见问题（自动回复）
2. 客服在群组中监控所有对话
3. 复杂问题时客服主动介入回复
4. 定期总结 AI 回复质量，优化 prompt

### 2. 工单管理规范

- 及时关闭已解决的工单 `/close`
- 定期清理旧工单 `/clear`
- 使用工单号追踪用户问题历史
- 记录高频问题，添加到自动回复

### 3. 监控与维护

- 每天检查日志是否有异常
- 每周备份 MongoDB 数据
- 每月评估 AI 回复质量
- 根据用户反馈优化 prompt

## 📞 技术支持

如遇问题，按以下顺序排查：

1. ✅ 查看本文档「故障排查」章节
2. ✅ 查看日志 `docker-compose logs bot`
3. ✅ 重启服务 `docker-compose restart`
4. ✅ 查看官方文档 [GitHub Wiki](https://github.com/bostrot/telegram-support-bot/wiki)
5. ✅ 提交 Issue 或联系开发者

---

**配置时间：** 2025-11-15  
**当前版本：** bostrot/telegram-support-bot:latest  
**AI 模型：** GPT-4o-mini  
**状态：** ✅ 配置完成，可以启动测试
